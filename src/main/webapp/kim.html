<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<style>
	#test{
		border:1px solid black;
	}
	.tag{
		color : red;
		
		
	}
	
	.tagHover{
		background-color:red;
	}
	
	.selectTag{
		background-color:gray;
	}
</style>
<script src="js/jquery-1.11.3.min.js"></script>
<script>
	$(document).ready(function(){
		var tagSet=false;
		var tagIndex;
		var liIndex=-1;
		
		$('#test').focus();
		$('#test').keypress(function(){
			if(event.keyCode==13 && $('.tagHover').length==1){
				
				var tagName=$('.tagHover').html();
				var uId=$('.tagHover').children().val();
				$('#test').html(function(index,html){
					
					
					var cursorPointer=window.getSelection().getRangeAt(0).startOffset;
				
					
					var start=html.substring(0,cursorPointer).lastIndexOf("@");
					
					var preTag=html.substring(start,cursorPointer);
					
					
					
					html=html.replace(html.substr(cursorPointer*(-1)),"<a class='tag' href='/abc.do?userId="+uId+"'>@"+tagName+"</a>");
					
					
					
					return html;
				})
				
			
				
				
				
				
				$('#list').html('');
				
				tagSet=false;
				elem = document.getElementById('test');
				setEndOfContenteditable(elem)
				event.preventDefault();
				
			}
		})
		$('#test').keyup(function(){
			
			
			if(event.keyCode==40){
				liIndex++;
				document.getElementById('test').nextSibling.nextSibling.children[liIndex-1].classList.remove('tagHover');
				document.getElementById('test').nextSibling.nextSibling.children[liIndex].classList.add('tagHover');
								
			}
			else if(event.keyCode==38){
				if(liIndex>-1){
					liIndex--;
				}
				document.getElementById('test').nextSibling.nextSibling.children[liIndex+1].classList.remove('tagHover');
				document.getElementById('test').nextSibling.nextSibling.children[liIndex].classList.add('tagHover');
				
			}
			var tag;
			
			if(!tagSet){
				
				tagIndex=$(this).html().length-1;
				
				tag=$(this).html().charAt(tagIndex);
				if(tag=='@'){
					
					tagSet=true;
				}
			}
			else{
				
				tag=$(this).html().charAt($(this).html().length-1);
				
				var str=$(this).html().substring(tagIndex+1,$(this).html().length);
				$.ajax({
					"url":"userTag.do",
					"type":"POST",
					"data":"str="+str,
					"dataType":"json",
					"success":function(obj){
						var txt="";
						$.each(obj.resData[0].tagList,function(idx){
							if(idx==liIndex)
								txt+="<li class='tagList tagHover' >"+this.userNm+" <input type='hidden' value='"+this.userId+"'/> </li>";
							else
								txt+="<li class='tagList' >"+this.userNm+" <input type='hidden' value='"+this.userId+"'/> </li>";
							
						})
						$('#list').html(txt);
						
						$('#list li').hover(function(){
							if(liIndex!=-1)
								document.getElementById('test').nextSibling.nextSibling.children[liIndex].classList.remove('tagHover');
							$(this).addClass('tagHover');
						},function(){
							$(this).removeClass('tagHover');
						})
					
					},
					"error":function(request,status,error){
				        $('div').html("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
				       }
				})
			}
			
			
			
			
			
		})
		
		
		
		$(document).on("click", ".tagList", function(){
			var tagName=$(this).html();
			var uId=$(this).children().val();
			$('#test').html(function(index,html){
				
				
				var cursorPointer=window.getSelection().getRangeAt(0).startOffset;
			
				
				var start=html.substring(0,cursorPointer).lastIndexOf("@");
				
				var preTag=html.substring(start,cursorPointer);
				
				
				
				html=html.replace(html.substr(cursorPointer*(-1)),"<a class='tag' href='/abc.do?userId="+uId+"'>@"+tagName+"</a>");
				
				
				
				return html;
			})
			
		
			
			
			
			
			$('#list').html('');
			
			tagSet=false;
			elem = document.getElementById('test');
			setEndOfContenteditable(elem)
			
		});
		
		$(document).click(function(){
			$('#list').html('');
		})
		
		
	})
		

function setEndOfContenteditable(contentEditableElement)
{
    var range,selection;
    if(document.createRange)//Firefox, Chrome, Opera, Safari, IE 9+
    {
        range = document.createRange();//Create a range (a range is a like the selection but invisible)
        range.selectNodeContents(contentEditableElement);//Select the entire contents of the element with the range
        range.collapse(false);//collapse the range to the end point. false means collapse to end rather than the start
        selection = window.getSelection();//get the selection object (allows you to change selection)
        selection.removeAllRanges();//remove any selections already made
        selection.addRange(range);//make the range you have just created the visible selection
    }
    else if(document.selection)//IE 8 and lower
    { 
        range = document.body.createTextRange();//Create a range (a range is a like the selection but invisible)
        range.moveToElementText(contentEditableElement);//Select the entire contents of the element with the range
        range.collapse(false);//collapse the range to the end point. false means collapse to end rather than the start
        range.select();//Select the range (make it the visible selection
    }
}	

	
	
</script>
</head>
<body>

<div id="tagTest">
	<div id="test" contenteditable="true"></div>
	<div id="list"></div>
</div>


</body>
</html>