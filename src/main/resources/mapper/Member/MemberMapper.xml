<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"     
          "http://mybatis.org/dtd/mybatis-3-mapper.dtd">    
<mapper namespace="com.teamnexters.mapper">   
	<select id="searchMember" resultType="com.teamnexters.dto.MemberDTO">  
	       SELECT * FROM member WHERE "userId" = #{userid} AND "userPw" = #{userpw}
	</select>
	<select id="searchByUserName" resultType="com.teamnexters.dto.MemberDTO">  
	       SELECT * FROM member WHERE "userId" = #{userid}
	</select>
	<select id="getMemberList" resultType="com.teamnexters.dto.MemberDTO">  
	       SELECT * FROM member
	</select>
	<select id="userTag" resultType="com.teamnexters.dto.MemberDTO">
		   SELECT "userId","userNm" FROM member WHERE "userNm" LIKE '%' || #{str} || '%'
	</select>
	<select id="getMemberListByGener" resultType="Map">  
	       SELECT "userNo", "userId", "userNm", "userCellNum" FROM member WHERE "userNo" LIKE '_' || #{gener} || '____' ORDER BY "userNm" ASC
	</select>
	<select id="getGenerList" resultType="Map">
		SELECT "gener"
			, count(*) as cnt
		FROM (
			SELECT substr("userNo", 2,2) as "gener" from member
		) as vTable1
		GROUP BY "gener"
		ORDER BY "gener" ASC
	</select>
	<insert id="insertUser" parameterType="com.teamnexters.dto.MemberDTO"  useGeneratedKeys="true">
		INSERT INTO member("userNo","userId","userNm","userCellNum","userStatus","userRole") VALUES ((SELECT MAX(substr("userNo", 0, 6))||MAX(substr("userNo", 5, 3))::numeric+1 FROM member WHERE "userNo" LIKE #{userNo} || '%') ,'1','1','1','3','2')
		<selectKey resultType="string" keyProperty="userNo" order="AFTER">
		   select 1
		</selectKey>
	</insert>
	
	<select id="getMemberDetailInfo" resultType="Map">
		select "userNo","userId","userNm","userCellNum",(select "value"
									from member_info_value
									where "userNo"=#{userNo} and "attr"='nowCompany') as nowCompany,
								(select "value"
									from member_info_value
									where "userNo"=#{userNo} and "attr"='finalSchool') as finalSchool
		from member
		where "userNo"=#{userNo}
	</select>
	
	
	<update id="updateMember">
		update member
		set "userNm"=#{userNm}
		where "userNo"=#{userNo};
		
		update member_info_value
		set "value"=#{nowCompany}
		where "userNo"=#{userNo} and "attr"='nowCompany';
		
		update member_info_value
		set "value"=#{finalSchool}
		where "userNo"=#{userNo} and "attr"='finalSchool'
	</update>
	
	<delete id="deleteMember">
		delete from member_info_value
		where "userNo"=#{userNo};
		delete from member
		where "userNo"=#{userNo}
		
	</delete>
</mapper>
